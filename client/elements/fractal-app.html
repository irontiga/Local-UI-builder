<link rel="import" href="/client/bower_components/polymer/polymer.html">

<script src="/client/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

<!-- POLYMER ELEMENTS -->
<link rel="import" href="/client/bower_components/paper-material/paper-material.html">
<link rel="import" href="/client/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/client/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/client/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/client/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="/client/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/client/bower_components/paper-item/paper-item.html">
<link rel="import" href="/client/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/client/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/client/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/client/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/client/bower_components/paper-item/paper-item.html">
<link rel="import" href="/client/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/client/bower_components/paper-ripple/paper-ripple.html">

<!-- Router -->
<link rel="import" href="/client/bower_components/app-route/app-location.html">
<link rel="import" href="/client/bower_components/app-route/app-route.html">

<!-- Fractal styles -->
<link rel="stylesheet" href="/client/fonts/roboto.css">
<link rel="stylesheet" href="/client/styles/main.css">

<!-- Custom elements -->
<link rel="import" href="/client/styles/app-theme.html">
<link rel="import" href="/client/elements/show-plugin.html">
<link rel="import" href="/client/elements/login-page.html">

<dom-module id="fractal-app">
	<template>
        <app-location route="{{route}}"></app-location>
        <app-route
                   route="{{route}}"
                   pattern="/fractal/:currentPluginUrl"
                   data="{{routeData}}"
                   tail="{{subroute}}">
        </app-route>
		
		<!--<div id="login-screen">
		
		</div>-->
        <login-page></login-page>
		
		<paper-drawer-panel>

			<paper-header-panel fixed drawer>

				<paper-toolbar>
					<span class="title">Burst</span>
				</paper-toolbar>

				<paper-menu>
					<template is="dom-repeat" items="{{urls}}">
                        <template is="dom-if" if="menus.length > 0">
                            <template is="dom-repeat" items="menus">
                                <a href="{{_genIframeUrl(item.url)}}">{{item.title}}</a>
                            </template>
                        </template>
                        
                        <template is="dom-if" if="menus.length = 0">
                            <paper-item>
                                <paper-ripple></paper-ripple>
                                <a style="display:block" is="pushstate-anchor" href="{{_genIframeUrl(item.url)}}">{{item.title}}</a>
                            </paper-item>
                        </template>
					</template>
				</paper-menu>

			</paper-header-panel>

			<paper-header-panel main>
				<paper-toolbar>
					<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
					<span class="title">Name - {{subroute.path}}</span>
					<paper-icon-button icon="refresh"></paper-icon-button>

					<paper-menu-button horizontal-align="right">
						<paper-icon-button icon="add" class="dropdown-trigger">+</paper-icon-button>
						<paper-menu class="dropdown-content">
							<paper-item>Share</paper-item>
							<paper-item>Settings</paper-item>
							<paper-item>Help</paper-item>
						</paper-menu>
					</paper-menu-button>
				</paper-toolbar>
				
                <show-plugin route="{{route}}" data="{{routeData}}" subroute="{{subroute}}" url="{{activeUrl}}"></show-plugin>
                
				<!--<template is="dom-repeat" items="{{urls}}">
					<iframe hidden$="{{_checkActiveRoute(item, route)}}" src="{{_joinPluginUrl(item.url)}}"></iframe>
				</template>
				
				<div hidden$="{{_checkPageNotFound(urls, route)}}" id="404-page">
					<h1>404</h1>
					<h3>Plugin not found</h3>
				</div>-->
			</paper-header-panel>

		</paper-drawer-panel>
		<!--<iframe id="plugin-js-loader" src="/client/plugin-js.html"></iframe>-->
	</template>
	<script src="/client/js/messageHandler.js"></script>
	<script src="/client/js/app.js"></script>
    <script>
        // Fetched plugins function
        function pluginLoader(plugins){

            for(var i=0; i<plugins.length;i++){
                
                var frame = document.createElement("iframe");
                frame.className += "pluginJSFrame";
                
                var insertedFrame = document.body.appendChild(frame);
                
                var helperScript = insertedFrame.contentWindow.document.createElement("script");
                helperScript.type = "text/javascript";
                helperScript.src = "/client/js/helpers.js";
                
                /*var helperActivatorScript = document.createElement("script");
                helperActivatorScript.setAttribute("type", "text/javascript");
                helperActivatorScript.text = "var Burst = new BurstHelper();";*/

                var pluginScript = insertedFrame.contentWindow.document.createElement("script");
                pluginScript.type = "text/javascript";
                pluginScript.src = "/plugins/" + plugins[i] + "/main.js";
                
                insertedFrame.contentWindow.document.body.appendChild(helperScript);
                /*insertedFrame.contentWindow.document.body.appendChild(helperActivatorScript);*/
                insertedFrame.contentWindow.document.body.appendChild(pluginScript);
            }
            
            // Send all plugins loaded message
            /*var script = document.createElement("script");
            script.innerHTML = "Burst.request({request:'pluginsLoaded')";
            document.body.appendChild(script);*/
        }


        // Fetch plugin list
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function(){

            if (xhttp.readyState == 4 && xhttp.status == 200) {

                var response = JSON.parse(xhttp.responseText);

                pluginLoader(response);
            }
        };
        xhttp.open("GET", "/getPlugins", true);
        xhttp.send();
    </script>
</dom-module>